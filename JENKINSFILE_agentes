pipeline {
    agent none
    options { timestamps() }

    stages {
        stage('Get Code') {
            agent any
            steps {
                echo "=== Get Code Stage ==="
                bat '''
                    @echo off
                    whoami
                    hostname
                    cd /d %WORKSPACE%
                    echo Workspace: %WORKSPACE%
                    dir
                '''
                checkout scm
                stash name: 'code', includes: '**/*'
            }
        }

        stage('Unit') {
            agent { label 'agent1' }
            steps {
                echo "=== Unit Tests Stage ==="
                bat '''
                    @echo off
                    whoami
                    hostname
                    cd /d %WORKSPACE%
                    echo Workspace: %WORKSPACE%
                '''
                unstash 'code'
                catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
                    bat '''
                        @echo off
                        cd /d %WORKSPACE%
                        set PYTHONPATH=%WORKSPACE%
                        python -m coverage run --branch --source=app -m pytest --junitxml=result-unit.xml test\\unit
                        python -m coverage xml -o coverage.xml
                        python -m coverage report
                    '''
                    junit 'result-unit.xml'
                    archiveArtifacts artifacts: 'coverage.xml', allowEmptyArchive: true
                    stash name: 'coverage-report', includes: 'coverage.xml'
                }
            }
        }

        stage('Rest') {
            agent { label 'agent2' }
            steps {
                echo "=== REST Tests Stage ==="
                bat '''
                    @echo off
                    whoami
                    hostname
                    cd /d %WORKSPACE%
                    echo Workspace: %WORKSPACE%
                '''
                unstash 'code'
                catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
                    bat '''
                        @echo off
                        cd /d %WORKSPACE%
                        set PYTHONPATH=%WORKSPACE%
                    
                        REM Clean previous processes
                        taskkill /F /IM python.exe /T 2>NUL || echo No Python processes to kill
                        timeout /t 2 /nobreak
                    
                        REM Start Flask in background
                        start "Flask" python -u -c "from app.api import api_application; api_application.run(host='0.0.0.0', port=5000)"
                        timeout /t 10 /nobreak
                    
                        REM Run REST tests
                        python -m pytest --junitxml=result-rest.xml test\\rest
                    
                        REM Cleanup
                        taskkill /F /IM python.exe /T 2>NUL || echo Flask stopped
                    '''
                    junit 'result-rest.xml'
                }
            }
        }

        stage('Static') {
            agent { label 'agent3' }
            steps {
                echo "=== Static Analysis Stage ==="
                bat '''
                    @echo off
                    whoami
                    hostname
                    cd /d %WORKSPACE%
                    echo Workspace: %WORKSPACE%
                '''
                unstash 'code'
                catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
                    bat '''
                        @echo off
                        cd /d %WORKSPACE%
                        python -m flake8 --exit-zero --format=pylint app > flake8.out
                    '''
                    recordIssues tools: [flake8(pattern: 'flake8.out')],
                        qualityGates: [[threshold: 8, type: 'TOTAL', unstable: true]]
                }
            }
        }

        stage('Security') {
            agent { label 'agent3' }
            steps {
                echo "=== Security Analysis Stage ==="
                bat '''
                    @echo off
                    whoami
                    hostname
                    cd /d %WORKSPACE%
                    echo Workspace: %WORKSPACE%
                '''
                unstash 'code'
                catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
                    bat '''
                        @echo off
                        cd /d %WORKSPACE%
                        python -m bandit -r app -f json -o bandit.json || exit /b 0
                    '''
                    recordIssues tools: [bandit(pattern: 'bandit.json')],
                        qualityGates: [[threshold: 2, type: 'TOTAL', unstable: true]]
                }
            }
        }

        stage('Performance') {
            agent { label 'agent2' }
            steps {
                echo "=== Performance Tests Stage ==="
                bat '''
                    @echo off
                    whoami
                    hostname
                    cd /d %WORKSPACE%
                    echo Workspace: %WORKSPACE%
                '''
                unstash 'code'
                catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
                    bat '''
                        @echo off
                        cd /d %WORKSPACE%
                        set PYTHONPATH=%WORKSPACE%
                    
                        REM Clean
                        taskkill /F /IM python.exe /T 2>NUL || echo No Python to kill
                        timeout /t 2 /nobreak
                    
                        REM Start Flask
                        start "Flask_Perf" python -u -c "from app.api import api_application; api_application.run(host='0.0.0.0', port=5000)"
                        timeout /t 10 /nobreak
                    
                        REM Clean JMeter results
                        if exist results.jtl del /f results.jtl
                        if exist jmeter-report rmdir /s /q jmeter-report
                    
                        REM Run JMeter
                        jmeter -n -t test\\jmeter\\flask.jmx -l results.jtl -j jmeter.log -e -o jmeter-report
                    
                        REM Cleanup
                        taskkill /F /IM python.exe /T 2>NUL || echo Flask stopped
                    '''
                    perfReport sourceDataFiles: 'results.jtl'
                }
            }
        }

        stage('Coverage') {
            agent { label 'agent1' }
            steps {
                echo "=== Coverage Report Stage ==="
                bat '''
                    @echo off
                    whoami
                    hostname
                    cd /d %WORKSPACE%
                    echo Workspace: %WORKSPACE%
                '''
                unstash 'coverage-report'
                catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
                    publishCoverage adapters: [istanbulCoberturaAdapter('coverage.xml')],
                        sourceFileResolver: sourceFiles('NEVER_STORE'),
                        globalThresholds: [
                            [thresholdTarget: 'Line', unhealthyThreshold: 85.0, unstableThreshold: 95.0],
                            [thresholdTarget: 'Conditional', unhealthyThreshold: 80.0, unstableThreshold: 90.0]
                        ]
                }
            }
        }
    }

    post {
        always {
            script {
                echo "=== Pipeline Completed ==="
                def agents = ['agent1', 'agent2', 'agent3']
                def archived = false
                
                for (agent in agents) {
                    if (!archived) {
                        try {
                            node(agent) {
                                echo "Archivando artefactos desde ${agent}"
                                bat '''
                                    @echo off
                                    whoami
                                    hostname
                                '''
                                unstash 'code'
                                archiveArtifacts artifacts: 'result-unit.xml,result-rest.xml,coverage.xml,flake8.out,bandit.json,results.jtl', allowEmptyArchive: true
                                archived = true
                            }
                        } catch (Exception e) {
                            echo "No se pudo archivar en ${agent}: ${e.message}"
                        }
                    }
                }
                
                if (!archived) {
                    echo "ADVERTENCIA: No se pudieron archivar artefactos en ning√∫n agente"
                }
            }
        }
    }
}